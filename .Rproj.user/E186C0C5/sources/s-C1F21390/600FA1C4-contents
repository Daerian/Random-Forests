---
title: "Tipping Factors"
author: "Daerian Dilkumar, Guan Yu Chen, Nithursan Elamuhilan, Derek Frempong, Grisham Nathan"
date: '2017-11-12'
header-includes:
   - \usepackage{bbm}
output:
  pdf_document: 
    number_sections: yes
---
\center{
  \textbf{UTorIDs, Student Numbers:}
}
\center{
dilkumar, 1000356198
}
\center{
chengu17, 1001591967
}
\center{
elamuhi1, 1001232597
}
\center{
frempon2, 1000566675
}
\center{
nathangr, 1001314927
}
\clearpage
\tableofcontents
\clearpage

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Abstract

The purpose of this study is to see if there is any relationship between any of the variables: total amount of bill, if bill was paid in credit card, number of guests, the day of the week, and size of tip as a percentage of the total bill. The hypothesis proposed is that bill affects the tip the most. The data was collected from a sample of 157  bills over a two week period. The results collected is that when including all the variables, and regressed on the data the bill was the only significant variable(p-value < $2.2X10^{-16}$). When excluding bill and percentage tip and doing analysis on each on the variables, it was found that credit and number of guests (Credit Y and guests 3+) to be statistically significant(p-value $4X10^{-6}$ and $5.68X10^{-4}$ respectively). From the results in the present study, using credit card, having more than 3 guests in a part and the bill affected the tip the most in this given sample.




# Introduction


In Potsdam, New York, the owner of a bistro called First Crush collected a representative sample of 157 bills at the bistro over a two-week period. For each observation, the owner recorded the following: the total amount of the bill, the amount of the tip, whether or not the bill was paid with a credit card (v.s. being paid in cash), the number of guests in the party, the day of the week, the server (labelled A, B or C), and the size of the tip as a percentage of the total bill.

The purpose of this study is to investigate whether there is any relationship between any of these variables, most of which are factors, and the size of the tip (CAD). What seem to be the most important of these variables in determining how big a tip will be left? 

We expect that the data will show us the following: 
The server will affect the tip. Due to variations in behavior
There are certain days in which the tips will be greater
The larger the amount of guests in a party, the more they will spend, thus a larger tip 
The use of cash to pay will limit how large the tip will be

We hypothesize that there is some relationship between any of these variables and the size of the tip, as listed in our expectations above. We also hypothesize that the most important variable in determining how big a tip will be left would be the bill amount.




Before we begin the analysis, we will import the following libraries in order to get the tools we need to perform our analysis. We begin by importing our required library

```{r}
library(tidyverse)
library(smmr) 
```


The data that was collected has been stored in a data file called "tips.txt" and stored in our project directory. Here we will bring our data in and have it ready to read and execute. Then we will ensure that the data has been parsed correctly into a usable data frame.

```{r}
tipData = read.table("tips.txt", header = T)
attach(tipData) # makes it easier to call variables later
glimpse(tipData)
```

The output above shows us that the variables that are numbers have correctly been read as doubles, and all categorical variables have been read as factors. This means all numbers have been stored in our data frame as numbers. and all categorical factors have been included as just that- factors. So far so good.


# Analysis of Data

Now that we have the data we want, we can begin our analysis. 

##  Effects of Server on Tips

The first factor we are checking is the Servers.

### Boxplot Visual Comparison
We can make use of box-plots to view comparisons on different Servers.
Given that the servers are labelled as A,B,C, and tips are numerically appraised based on true value, we have that the ideal method of graphing is box plot since we are comparing a quantitative variable to a categorical variable. Then we create box-plots and see what inferences we can make:

```{r}
ggplot(tipData, aes(x=Server,y=Tip,fill=Server))+geom_boxplot()
```

From first taking a look at the plot we have created it seems that server A has large outliers above implying that every once in a while they get tips that are significantly larger than average. In addition B also seems to experience this phenomena at a lower rate (1 instead of 3.) Server C on the other hand has no significantly larger tips, however has a slightly higher median of tips and has a consistent spread slightly above the others as well (as indicated by the upper whisker of the box-plot reaching a higher value that those of servers A and B.)

It is however interesting to notice that mean values for this case will be affected by the outliers present above some boxes. So we will test the normality of the design in order to see if we can compare means without having their values too skewed by the outliers only existing on some plots and not others. In the event that the terms are not considered normal, we will have to employ tests on medians which are not affected by the outliers that exist. 


### Normality Testing 

In order to test for normality we will employ a linear model and plot the residuals against the fitted values. If the values of the residuals fall within the range of -3 to 3, then the model is normal and we can test assuming a normal distribution of data.

```{r}
Servtip = lm(Tip~Server,data=tipData) # model
plot(Servtip) # graphs that we can interpret to test normality
abline(3,0,lty=3) # line to make visualization easier
abline(-3,0,lty=3) # line to make visualization easier
```

Then from the graphs above we make the following observations:
- Residuals vs Fitted: The values far exceed the -3 to 3 range
- Normal Q-Q: The plotted values are nonlinear and not on the line
- Scale-Location: We notice that there is a pattern here, where none should exist. The values all group together and line up/
- Cooke's Distance plot shows a strange plotting of values without any of them being particularly deviant. However we know there are outliers in the data.

The combination of these plots has lead us to the following conclusion: This data is not suitable to be tested using the mean. They are non-normal and therefore t-tests and other things relevant to it are suspicious in stability.

Therefore to proceed we should use the median value or another form of test in order to ensure fair and valid testing. We will try and group these then use Tukey's Method with Mood's median test instead.


### Mood's Median Test

First we will take a look at Mood's Median Test.
We then have the following set of Hypotheses:\
$H_0$: There server does not affect tip value\
$H_A$: The server does affect the value of the tip

```{r}
 median_test(tipData, Tip, Server)
```

The Mood's median test shows a p-value greater than 0.05 - in fact it is much larger, at 0.3379216.  These results are therefore not enough to stand on, and we will require additional tests. 


### Tukey's Honest Significant Difference

This means that we will need to employ Tukey's HSD test to find differences in mean and test weather these differences are significant. In order to do this we will perform Tukey Honest Significant Differences procedure in order to test differences between the means of the given categories after adjusting for accounting for the pull on means. Then we find the following set of hypotheses appropriate:

$H_0$: Server tip means are the same.
$H_A$: At least one of the means is significantly different.

```{R}
Servtip_aov = aov(Tip~Server,data=tipData)
TukeyHSD(Servtip_aov)
```

Tukey HSD show us that all the categories have 0 in the interval and none of them have a p-value less than 0.05.


### Bonferroni's Correction - Family-Wise Confidence

To confirm then, we will employ Bonferroni's Correction and look at the visual effects in order to reach a conclusion about this factor.

```{r}
plot(TukeyHSD(Servtip_aov))
```

In the plot above we more easily visualize the that the intervals in Tukey's HSD above do in fact cross the 0 line and that they are not at all far apart. They have roughly the same size and are near each other in distance. Therefore they are not statistically different at a significance level of 0.05. 




### Inclusion of days.

Some would argue that the days on which the servers work would play a part in how much money they make. Let's take a look at the box-plots that would show us what we need to see

```{r}
ggplot(tipData, aes(x=Server,y=Tip,fill=Server))+geom_boxplot()+facet_wrap(~Day)
```

We can see that the plots once again show the same spreads. In addition the only times there are missing servers are Mondays and Tuesdays. On these days however we notice that if a server works one of these days they do not work the other. Ie: If the work Tuesday they do not work Monday and vice versa. Therefore we can compare these values and see the differences. Given that the plots are next to one another this makes our job straightforward. We see that the data is once again the same as above and on every other day.




## Effects of Payment Method on Tips

We expected that those carrying cash will be limited by the amount that they have on them, in addition, we can expect that they would not tip with larger bills. Since Credit does not place these limits on the guest we expect that they will tip better. We will compare the Tips received when the guests payed with cash as opposed to when the guests paid with credit,
This time however we will not need to compare day because we expect this holds regardless of day.

```{r}
ggplot(tipData, aes(x=Credit,y=Tip,fill=Credit))+geom_boxplot()
```

Again we find outliers. So we use median methods instead to compare

### T-test


### Mood's Median Test

First we will take a look at Mood's Median Test.

We then have the following set of Hypotheses:
$H_0$: Payment method does not affect tip value\
$H_A$: Payment method does not affect tip value

```{r}
 median_test(tipData, Tip, Credit)
```
P-value is low and we see that group n has more tips below the median tips and group y has more tips above the median tips for credit group.



### Tukey's Method

We will en use Tukey's to confirm the null from above.\
We then have the following set of Hypotheses:
$H_0$: Payment method does not affect tip value
$H_A$: Payment method does affect tip value\
```{r}
Servcred_aov = aov(Tip~Credit,data=tipData)
TukeyHSD(Servcred_aov)
```

Again we find a low p-value.

just to see, lets see visually if Credit and bill are related, as people usually tip on a percentage

```{r}
ggplot(tipData, aes(x=Bill, y=Tip, color=Credit)) + geom_point() 

```

interestingly it looks like people use cash when their bill is usually lower, but people use credit regardless of their bill


## Effects of the number of guests on the tip

To proceed we will now compare the number of guests to the tips earned.
We hypothesize that as the number of guests increases so too will the tips in proportional value.
We can start by first using box-plots so as to visually check our hypothesis.

```{r}
ggplot(tipData, aes(x=as.factor(Guests),y=Tip,fill=Guests))+geom_boxplot()
```

The plots show us that our hypothesis seems to e on he right track. Therefore there are tests we can perform here to test. Also we notice that tables of 1 or 2 guests have very many outliers that will pull the mean tip size up. Therefore we take into account these values

### Regression Analyis.

We begin by trying to fit a linear model to try and predict tips based on number of guests.
Before we perform test however we will check to see if a linear model is an accurate fit. We will once again check the four regression linearity plots and examine them to see if the linear regressive model is appropriate.

```{r}
gt_reg = glm(Tip~Guests, data = tipData)
plot(gt_reg)
```

From the above charts we once again see the following:
- Residuals vs Fitted: The values are not in the the -3 to 3 range\
- Normal Q-Q: The plotted values are nonlinear, in fact they jump drastically around Q2\
- Scale-Location: We notice that the values are lined up vertically in intervals.\ 
- Cooke's Distance: We find that this plot shows high amounts of variability. \

The combination of these plots shows this data is not suitable to be tested using the regression model or to undergo mean testing. Therefore we need to use median or some alternate methods of testing validly.

Once again we will rely on Tukey's Method with Mood's median test instead.


### Mood's Median Test

First we will take a look at Mood's Median Test.
We then have the following set of Hypotheses:
$H_0$: The number of guests do not affect tip value
$H_A$: The number of guests affect tip value

```{r}
 median_test(tipData, Tip, Guests)
```

The Mood's median test shows a p-value much lower than 0.05!

To find out which and to be more specific we will utilize Tukey's Honest Significant Differences.


### Tukey's Honest Significant Difference

Given that there are statistically significant differences in median, we can then compare differences via the use of Tukey HSD. This compares means but we have the evidence from above that even though there are outliers, the same values affected by outliers are also the only ones with values below the median. Making Tukey's a valid test.

We test with the following set of Hypothesis:
$H_0$: No categories  of guest have any significantly different averages
$H_A$: At least one of the averages of the categories of guest are significantly different.

```{R}
Guesttip_aov = aov(Tip~as.factor(Guests))
TukeyHSD(Guesttip_aov)
```

Interestingly this data shows that there are many significant group differences. The adjusted p-values show many groups for which are significant


### Bonferoni's Confidence Interval

For a better visual, we inspect Bonferroni's family-wise confidence interval, and look for groups whose intervals are NOT crossing the zero line.

```{r}
plot(TukeyHSD(Guesttip_aov))
```

The confidence interval graph above shoes us that there are a large number of significant group differences. namely: the first 6 group differences, along with 5-2, 6-2, and 6-3.
There are then a total of 9 significant differences.




### Visual of Model

We can view this model to see the relationship. The green dots will represent the data and the blue dots will be used to represent the means. The pink line is a representation of the line of best fit for the means, and will be what shows us the relationship if any exists.

```{r}
# plot(Tip~Guests)
gt_mean = aggregate(Tip~Guests, tipData, mean)

ggplot(tipData, aes(x=Guests, y=Tip)) + geom_point(colour = "lightgreen") +
  stat_summary(fun.y=mean,colour="blue",geom="point") +
  geom_text(data = gt_mean, aes(label = "")) + 
  geom_smooth(method = "lm",se = FALSE,colour="pink")
```


The pink line shows a positive slope through the data points. Therefore we can conclude that as the number of gusts increases, the amount tipped also increases. We notice however that the actual data points seem to taper off for points after 4 guests. 


### Additional effect of Server

Let us now consider what happens when we try and visualize the effect that servers play.

```{r}
ggplot(tipData, aes(x=Guests, y=Tip, color=Server)) + geom_point() +
  geom_smooth(method = "lm",se = FALSE,colour="yellow")
tip_serv =lm(Tip~Server+Day+Guests+Credit)
anova(tip_serv)
```

Our graph shows that Server C seems to be sent to or approaches tables of larger numbers of guests. Interestingly even though Server A is sent to tables with lower numbers of guests (doesn't ever appear for numbers greater than 4,) the server also seems to have received amongst the higher values of tips - perhaps by luck, since they also received the lowest values of tips.


### Inclusion of Days on Effect

We can view information on Day for the same effect by using colours to represent the days.

```{r}
ggplot(tipData, aes(x=Guests, y=Tip, color=Day)) + geom_point() +
  geom_smooth(method = "lm",se = FALSE,colour="yellow")
guesttip = lm(Tip~Guests+Day)
summary(guesttip)
```

Interestingly we see that the larger number of guests tend to arrive before Friday. In fact, the most common are Thursdays. The largest number of guests however appear before Wednesday. Perhaps then, this is due to business meetings taking place, and therefore we can say that if one hopes to get larger tips, perhaps working on one of these days would help. However there are  a lot more visits during Wednesdays even if they are less in magnitude of the tips, which means that the sum of tips for the day would be largest on Wednesday.


### Effect of Payment Method
  
Let us see how the numbers of guests plays an effect of payment method.

```{r}
ggplot(tipData, aes(x=Guests, y=Tip, color=Credit)) + geom_point() +
  geom_smooth(method = "lm",se = FALSE,colour="yellow")
```

It looks as if for the higher number of guests the payment method plays no effect. However from lower number of guests, we can see that most of the higher tips are payed using a credit card, however the lower number is paid using cash. 

In conjunction with the effect of days on the criterion, we see that Tuesdays and Wednesdays are the days in which most people pay using credit cards, and tip more. 


Lets take a look at how the number of guests affects the bill:

```{r}
ggplot(tipData, aes(x=as.factor(Guests),y=Bill))+geom_boxplot()
```

Interestingly we can see that while as the number of guests increases so too does the average bill amount, the largerst bills come from the lower number of guests.

## Bill vs Tip

Our question is: is there a relationship between bill and top

 now lets do a regression with bill vs tip, but first let us  plot the data 
 
### Plotting the relationship

```{r}
ggplot(tipData, aes(x=Bill,y=Tip))+geom_point()+geom_smooth(method="lm")
```

As shown in the graph it seems to show as bill increases, the tip tends to increase as well in a straight line. Lets see how well a line fits

### Fitting the regression line

Before any inferences are made let us do an hypothesis test:\

$H_0:$ Bill does not affect tip value:\
$H_A$ Bill affects tip value

```{r}
Billtip = lm(Tip~Bill,data=tipData) # model
summary(Billtip)

```

The p-value is very small, and the multiple R-squared is 0.8373

let us plot the residuals to see what it looks like

```{r}
resid=ggplot(Billtip,aes(y=.resid,x=.fitted))+
geom_point()+geom_smooth(se=F);resid



```


the the vast majority of the residuals  are random and are between -3 and 3 except for 3 point,so overall so using a linear is good.



## Effect of all categorical variables on tip


### Fitting Linear model


We hypothesized that the largest factor would be bill, so lets see what happens when we leave out tip and only test the categorical variables, Guests, Credit, Day, Server


```{r}
cat_lm = lm(Tip~Credit+Guests+Day+Server)
summary(cat_lm)
```

Interestingly enough, we find that Server B is significant, along with Credit y and Guests, $R^2$ is a bit low but let us check the residuals

### Residual model
$R^2$ value is not good so let us plot the residuals to see

```{r}
resid_cat=ggplot(cat_lm,aes(y=.resid,x=.fitted))+
geom_point()+geom_smooth(se=F);resid_cat
```


most of the residuals are between -3 and 3, so this is ok, the p-values are the most important.


## Effect on all variables on tip.


### Fitting Linear Model
Now we know how each variable affects tip independently, now let's see if a model can be fit with all 5 variables:\

```{r}
full_lm = lm(Tip~Bill+Credit+Guests+Day+Server)
shapiro.test(cbind(Tip))
summary(full_lm)
```

So we see from the full model, that from the variables all of them are insignificant except for Bill, which has a p value less than $2X10^{-16}$



#Conclusion

The question we are trying to answer is: what variables in our data effects tips the most? Well, We we found that when Server is isolated from the rest of the variables, we found none of the servers have a statistically significant difference in tips, meaning the difference of being zero, so we can conclude that, the servers in this study in general do not affect the value of the tip being earned, on its own, but When we did further analysis and added in the other categorical variables, we found that Server B affected tips when alongside Credit y and Guests, but by plotting a graph, we found that Server B was the server on the lower end of tips and interestingly when the customers chose not to use credit.\

So all in all, when regressing only on Server, we found no significant different difference in tip earned. However, when we added in the other categorical variables we found that Server B reached statistical significance, meaning that we reject the null hypothesis that servers don't affect the tip and conclude that, in the context of a regression with all the categorical variables, that there is at least 1 server(Server B in this case) that influences the amount of tips earned, and in a negative way when we did further analysis with a graph and looked at the coefficient (-0.85075), but with a median test none of the variables in category server reached statistical significance, the relationship with Server B and tip is there but due to outliers the mideian test would be more appropiate and we conclude there is no difference between the tips of the servers..


Now we wanted to see if payment method effected tips, we initially expected those carrying cash would be limited by the amount of tip they can give, so we did a box-plot to compare if there is a visual difference and to test normality. We found there looks like there is difference and there were outliers so we decided to use moods median test. When we ran moods median test. The p-value we obtained was very small($1.6X10^{-4}$) and when looking at the table group y of Credit had more tips above the median than below (36 vs 14) and group n of Credit had less tips above the median that below(42 vs 64). So we conclude that when customers used credit, they tended  to tip more, but we also found that people used credit more when their bill is higher.


Our next variable to test is Guest. We wanted to see if the number of guests affects the tips earned. When we plotted the relationship via side-by-side box-plots, we find there is a positive relationship between  number of guests and tip. there are too many outlier in the side-by-side box-plots, particularly the first and second box-plot. Also box-plot 6 and 7, the spread is too small, due to lack of data. So we decide to do a moods median test. We had a statistically significant difference but only for group 3 (guests with 3 people). When we applied Tukey's Honest significant Difference and Bonferoni's confidence intervals, we found that group 3 4 and 5 has significant differences in amount tip given, but after 4 guests the amount of data is limited, so we can infer that in there was more data we would be more data after 4 guests

Now when we did Day vs Tip we did not find any significant differences but we did find some interesting about day in conjunction to other variables. we noticed that most guests appear before Wednesday. And there are a lot of guests on Wednesday in particular, so the sum of the tips would be largest of Wednesday


When we did the full model with all the variables, including bill we found, like expected that the bill amount would be the most significant factor in the amount of tips, and other variables are insignificant when paired with tip, but this does not that mean the other variables are insignificant. Bill vs tip will always have a positive relationship as most people usually do tips based on a percentage of their Bill. So when we got rid of the Bill variable and just looked at the categorical variables we found that if guests used Credit and the number the guests affect tip the most other than Bill.
So what variables affect tip the most?The variables that affect tip the most is: bill, how much they spent in the restaurant, credit Y, if guests used credit card and guests, the number of guests per group, particularily more guests, more tip.









